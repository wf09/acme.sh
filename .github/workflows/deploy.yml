name: ACME automation

on:
  push:
    branches: [ main ]
env:
  TZ: Asia/Shanghai
  acme: /home/runner/.acme.sh/acme.sh
  domain_name: ${{ secrets.domain_name }}
  dns: ${{ secrets.dns }}
  DP_Id: ${{ secrets.DP_Id }}
  DP_Key: ${{ secrets.DP_Key }}
  eab_kid: ${{ secrets.eab_kid }}
  eab_hmac_key: ${{ secrets.eab_hmac_key }}
  acme_server: ${{ secrets.acme_server }}
jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2.3.4
    
    - name: Install acme.sh
      run: curl https://get.acme.sh | sh
        
    - name: Check acme.sh
      run: ${acme} -h
      
    - name: Register account
      run: |
        $acme  --register-account --server $acme_server --eab-kid $eab_kid --eab-hmac-key $eab_hmac_key
    - name: Issue certificate
      run: |
        $acme --server $acme_server --issue --dns $dns -d $domain_name
        
    - name: Deliver certificate
      uses: actions/upload-artifact@v2
      with:
        name: $domain_name
        path: /home/runner/.acme.sh/$domain_name
         

          
      