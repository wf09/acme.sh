name: ACME automation

on:
  push:
    branches: [ main ]
env:
  TZ: Asia/Shanghai
  acme: /home/runner/.acme.sh/acme.sh
  DP_Id: ${{ secrets.DP_Id }}
  DP_Key: ${{ secrets.DP_Key }}
jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2.3.4
    
    - name: Install acme.sh
      run: curl https://get.acme.sh | sh
        
    - name: Check acme.sh
      run: ${acme} -h
      
    - name: Register account and Issue certificate
      env:
        dns: ${{ secrets.dns }}
        eab_kid: ${{ secrets.eab_kid }}
        eab_hmac_key: ${{ secrets.eab_hmac_key }}
        acme_server: ${{ secrets.acme_server }}
        domain_name: ${{ secrets.domain_name }}
      run: |
        $acme  --register-account --server $acme_server --eab-kid $eab_kid --eab-hmac-key $eab_hmac_key
        $acme --server $acme_server --issue --dns $dns -d $domain_name
        
    - name: Deliver certificate
      uses: actions/upload-artifact@v2
      with:
        name: ${{ secrets.domain_name }}
        path: /home/runner/.acme.sh/${{ secrets.domain_name }}
         

          
      